import fs from "fs";
import {execSync} from "child_process";

execSync('rm -rf aa || true', {stdio: 'inherit'});
execSync('flutter create --platforms ios,android --org=ku.mergo -e aa');
execSync('rm -rf aa/android/app/src/res || true', {stdio: 'inherit'});
execSync("bun buildx", {stdio: 'inherit'});
fs.mkdirSync('aa/assets', {recursive: true});
fs.copyFileSync('./dist/index.cjs', './aa/index.cjs');
fs.copyFileSync('./assets/pubspec.yaml', './aa/pubspec.yaml');
fs.copyFileSync('./assets/.env', './aa/.env');
fs.copyFileSync('./assets/manifest.xml', './aa/android/app/src/main/AndroidManifest.xml');
fs.copyFileSync('./assets/icon_transparent.png', './aa/assets/icon_transparent.png');
fs.copyFileSync('./assets/icon_with_title.png', './aa/assets/icon_with_title.png');
fs.copyFileSync('./assets/test_avatar.png', './aa/assets/test_avatar.png');
execSync('cd aa && bun run index.cjs', {stdio: 'inherit'});
execSync('cd aa && bun run index.cjs --help', {stdio: 'inherit'});

const runIndex = process.argv.findIndex(t => t == '-r' || t.startsWith('-r='));
if (runIndex !== -1) {
    const val = process.argv[runIndex].includes('=') ? process.argv[runIndex].split('=')[1] : process.argv[runIndex + 1];
    if (val == 'a' || val == 'i') {
        const devices = execSync('cd aa && flutter devices --device-connection=attached').toString().split('\n');
        for (const device of devices) {
            if ((val == 'a' && device.includes('android-arm64')) || (val == 'i' && device.includes('ios'))) {
                const deviceId = device.split('â€¢')[1].trim();
                execSync(`cd aa && flutter run -d ${deviceId}`, {stdio: 'inherit'});
            }
        }
    }
}